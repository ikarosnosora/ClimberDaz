import{l as t}from"./notifications-DK5Y3Ipx.js";import{R as e}from"./router-DIp0qzM7.js";import{o as s}from"./storage-BRXjPTYW.js";var i=Object.defineProperty,n=(t,e,s)=>((t,e,s)=>e in t?i(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);const a=class t{constructor(){n(this,"notifications",[]),n(this,"listeners",[])}static getInstance(){return t.instance||(t.instance=new t),t.instance}subscribe(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notify(){this.listeners.forEach((t=>t(this.notifications)))}show(t){const e={...t,duration:t.duration||3e3};this.notifications.push(e),this.notify(),setTimeout((()=>{this.remove(e)}),e.duration)}remove(t){const e=this.notifications.indexOf(t);e>-1&&(this.notifications.splice(e,1),this.notify())}clear(){this.notifications=[],this.notify()}};n(a,"instance");const r=a.getInstance(),o=t=>{r.show(t)},c=(t,e)=>{o({content:t,type:"success",duration:e})},h=(t,e)=>{o({content:t,type:"error",duration:e})},d=(t,e)=>{o({content:t,type:"warning",duration:e})},l=(t,e)=>{o({content:t,type:"info",duration:e})},u=()=>{const[t,s]=e.useState([]);return e.useEffect((()=>r.subscribe(s)),[]),{notifications:t,showToast:o,showSuccess:c,showError:h,showWarning:d,showInfo:l}};var y={},p=Object.defineProperty,m=(t,e,s)=>((t,e,s)=>e in t?p(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);const b=new class{constructor(){m(this,"socket",null),m(this,"isConnected",!1),m(this,"reconnectAttempts",0),m(this,"maxReconnectAttempts",5),m(this,"reconnectDelay",1e3),m(this,"eventListeners",new Map),m(this,"currentUserId",null),this.setupVisibilityHandlers()}async connect(e,s){if(!this.socket?.connected){this.currentUserId=e;try{return this.socket=t(y.REACT_APP_WS_URL||"ws://localhost:3002",{auth:{token:s,userId:e},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay}),this.setupSocketHandlers(),new Promise(((t,e)=>{const s=setTimeout((()=>{e(new Error("Connection timeout"))}),1e4);this.socket.on("connect",(()=>{clearTimeout(s),this.isConnected=!0,this.reconnectAttempts=0,t()})),this.socket.on("connect_error",(t=>{clearTimeout(s),e(t)}))}))}catch(i){throw i}}}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.isConnected=!1,this.currentUserId=null)}isSocketConnected(){return this.isConnected&&!0===this.socket?.connected}joinActivityRoom(t){this.socket?.connected&&this.socket.emit("join_activity",{activityId:t})}leaveActivityRoom(t){this.socket?.connected&&this.socket.emit("leave_activity",{activityId:t})}sendActivityUpdate(t,e){this.socket?.connected&&this.socket.emit("activity_update",{activityId:t,...e,timestamp:new Date})}subscribe(t,e){return this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(e),()=>{const s=this.eventListeners.get(t);s&&(s.delete(e),0===s.size&&this.eventListeners.delete(t))}}emit(t,e){const s=this.eventListeners.get(t);s&&s.forEach((t=>{try{t(e)}catch(s){}}))}setupSocketHandlers(){this.socket&&(this.socket.on("connect",(()=>{this.isConnected=!0,this.reconnectAttempts=0,this.emit("connected",{timestamp:new Date})})),this.socket.on("disconnect",(()=>{this.isConnected=!1,this.emit("disconnected",{timestamp:new Date})})),this.socket.on("reconnect",(t=>{this.emit("reconnected",{attempts:t})})),this.socket.on("reconnect_error",(t=>{this.reconnectAttempts++})),this.socket.on("activity_update",(t=>{this.handleActivityUpdate(t),this.emit("activity_update",t)})),this.socket.on("participant_joined",(t=>{this.handleParticipantJoined(t),this.emit("participant_joined",t)})),this.socket.on("participant_left",(t=>{this.handleParticipantLeft(t),this.emit("participant_left",t)})),this.socket.on("new_comment",(t=>{this.handleNewComment(t),this.emit("new_comment",t)})),this.socket.on("review_reminder",(t=>{this.handleReviewReminder(t),this.emit("review_reminder",t)})),this.socket.on("activity_completed",(t=>{this.handleActivityCompleted(t),this.emit("activity_completed",t)})),this.socket.on("error",(t=>{this.emit("error",t)})))}handleActivityUpdate(t){const{activityId:e,message:s}=t;r.show({type:"info",title:"活动更新",message:s,duration:5e3,actions:[{label:"查看",action:()=>{window.location.href=`/activity/${e}`}}]})}handleParticipantJoined(t){const{participant:e,activityId:s}=t;e&&r.show({type:"success",title:"新成员加入",message:`${e.name} 加入了活动`,duration:4e3,actions:[{label:"查看活动",action:()=>{window.location.href=`/activity/${s}`}}]})}handleParticipantLeft(t){const{participant:e}=t;e&&r.show({type:"warning",title:"成员退出",message:`${e.name} 退出了活动`,duration:4e3})}handleNewComment(t){const{activityId:e,author:s,content:i}=t;r.show({type:"info",title:"新留言",message:`${s.name}: ${i.substring(0,50)}${i.length>50?"...":""}`,duration:4e3,actions:[{label:"回复",action:()=>{window.location.href=`/activity/${e}#comments`}}]})}handleReviewReminder(t){const{activityId:e,targetUserName:s,activityTitle:i}=t;r.show({type:"warning",title:"评价提醒",message:`请评价 ${s} 在「${i}」中的表现`,duration:8e3,actions:[{label:"去评价",action:()=>{window.location.href=`/review/${e}/${t.targetUserId}`}},{label:"稍后提醒",action:()=>{setTimeout((()=>{this.handleReviewReminder(t)}),36e5)}}]})}handleActivityCompleted(t){const{activityId:e,message:s}=t;r.show({type:"success",title:"活动完成",message:s,duration:6e3,actions:[{label:"查看详情",action:()=>{window.location.href=`/activity/${e}`}}]})}setupVisibilityHandlers(){"undefined"!=typeof document&&document.addEventListener("visibilitychange",(()=>{document.hidden||!this.isConnected&&this.currentUserId&&this.attemptReconnect()})),"undefined"!=typeof window&&(window.addEventListener("online",(()=>{!this.isConnected&&this.currentUserId&&this.attemptReconnect()})),window.addEventListener("offline",(()=>{this.emit("network_offline",{timestamp:new Date})})))}async attemptReconnect(){if(this.currentUserId&&!(this.reconnectAttempts>=this.maxReconnectAttempts))try{const t=localStorage.getItem("auth_token");t&&await this.connect(this.currentUserId,t)}catch(t){}}sendTypingIndicator(t,e){this.socket?.connected&&this.socket.emit("typing",{activityId:t,isTyping:e,timestamp:new Date})}updateUserStatus(t){this.socket?.connected&&this.socket.emit("user_status",{status:t,timestamp:new Date})}},g=()=>{const[t,s]=e.useState(!1),[i,n]=e.useState(null);return e.useEffect((()=>{const t=b.subscribe("connected",(()=>{s(!0)})),e=b.subscribe("disconnected",(()=>{s(!1)})),i=b.subscribe("activity_update",(()=>{n(new Date)}));return()=>{t(),e(),i()}}),[]),{isConnected:t,lastUpdate:i,connect:b.connect.bind(b),disconnect:b.disconnect.bind(b),joinActivityRoom:b.joinActivityRoom.bind(b),leaveActivityRoom:b.leaveActivityRoom.bind(b),subscribe:b.subscribe.bind(b),sendTypingIndicator:b.sendTypingIndicator.bind(b),updateUserStatus:b.updateUserStatus.bind(b)}};var f={},w=Object.defineProperty,v=(t,e,s)=>((t,e,s)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);const F=new class{constructor(){v(this,"db",null),v(this,"syncInProgress",!1),v(this,"syncListeners",new Set),v(this,"dataChangeListeners",new Set),v(this,"isOnline",navigator.onLine),v(this,"syncInterval",null),this.setupNetworkHandlers(),this.initDatabase()}async initDatabase(){try{this.db=await s("climber-daz-offline",1,{upgrade(t){t.createObjectStore("activities",{keyPath:"id"}),t.createObjectStore("users",{keyPath:"id"}),t.createObjectStore("comments",{keyPath:"id"}),t.createObjectStore("reviews",{keyPath:"id"});const e=t.createObjectStore("syncQueue",{keyPath:"id",autoIncrement:!0});e.createIndex("by-status","status"),e.createIndex("by-entity","entity")}}),this.isOnline&&this.startSyncProcess()}catch(t){}}setupNetworkHandlers(){window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this))}handleOnline(){this.isOnline=!0,r.show({type:"success",title:"网络已连接",message:"正在同步数据...",duration:3e3}),this.startSyncProcess(),this.notifySyncListeners()}handleOffline(){this.isOnline=!1,r.show({type:"warning",title:"网络已断开",message:"应用将以离线模式运行",duration:4e3}),this.stopSyncProcess(),this.notifySyncListeners()}startSyncProcess(){this.isOnline&&!this.syncInterval&&(this.syncData(),this.syncInterval=setInterval((()=>{this.isOnline&&!this.syncInProgress&&this.syncData()}),3e4))}stopSyncProcess(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}async storeData(t,e,s="synced"){if(this.db)try{const i={id:e.id,data:e,lastModified:new Date,syncStatus:s,..."comments"===t||"reviews"===t?{activityId:e.activityId}:{}};await this.db.put(t,i),this.notifyDataChangeListeners()}catch(i){}}async getData(t,e){if(!this.db)return null;try{if(e){const s=await this.db.get(t,e);return s?.data||null}return(await this.db.getAll(t)).map((t=>t.data))}catch(s){return null}}async queueOperation(t,e,s,i){if(this.db)try{const n={type:t,entity:e,entityId:s,data:i,timestamp:new Date,retries:0,maxRetries:3,status:"pending"};await this.db.add("syncQueue",{...n,id:Date.now()}),this.isOnline&&this.syncData(),this.notifySyncListeners()}catch(n){}}async syncData(){if(this.db&&this.isOnline&&!this.syncInProgress){this.syncInProgress=!0,this.notifySyncListeners();try{const t=await this.db.getAllFromIndex("syncQueue","by-status","pending");for(const e of t)await this.syncOperation(e);await this.cleanupCompletedOperations()}catch(t){}finally{this.syncInProgress=!1,this.notifySyncListeners()}}}async syncOperation(t){if(this.db)try{t.status="processing",await this.db.put("syncQueue",t);const e=this.getApiEndpoint(t.entity);let s;switch(t.type){case"create":s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(t.data)});break;case"update":s=await fetch(`${e}/${t.entityId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(t.data)});break;case"delete":s=await fetch(`${e}/${t.entityId}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});break;default:throw new Error(`Unknown operation type: ${t.type}`)}if(!s.ok)throw new Error(`API error: ${s.status} ${s.statusText}`);if(t.status="completed",await this.db.put("syncQueue",t),"delete"!==t.type){const e=`${t.entity}s`,s=await this.db.get(e,t.entityId);s&&"syncStatus"in s&&(s.syncStatus="synced",await this.db.put(e,s))}else{const e=`${t.entity}s`;await this.db.delete(e,t.entityId)}}catch(e){t.retries++,t.retries>=t.maxRetries?(t.status="failed",r.show({type:"error",title:"同步失败",message:`${t.entity} 数据同步失败，请检查网络连接`,duration:5e3})):t.status="pending",await this.db.put("syncQueue",t)}}getApiEndpoint(t){const e=f.REACT_APP_API_URL||"http://localhost:3002/api";return{activity:`${e}/activities`,user:`${e}/users`,comment:`${e}/comments`,review:`${e}/reviews`}[t]||e}async cleanupCompletedOperations(){if(this.db)try{const t=(await this.db.getAllFromIndex("syncQueue","by-status","completed")).filter((t=>Date.now()-t.timestamp.getTime()>864e5));for(const e of t)await this.db.delete("syncQueue",e.id);t.length}catch(t){}}async getSyncStatus(){if(!this.db)return{isOnline:this.isOnline,lastSyncTime:null,pendingOperations:0,failedOperations:0,syncInProgress:this.syncInProgress};try{const t=await this.db.getAllFromIndex("syncQueue","by-status","pending"),e=await this.db.getAllFromIndex("syncQueue","by-status","failed"),s=localStorage.getItem("last_sync_time");return{isOnline:this.isOnline,lastSyncTime:s?new Date(s):null,pendingOperations:t.length,failedOperations:e.length,syncInProgress:this.syncInProgress}}catch(t){return{isOnline:this.isOnline,lastSyncTime:null,pendingOperations:0,failedOperations:0,syncInProgress:this.syncInProgress}}}subscribeSyncStatus(t){return this.syncListeners.add(t),this.getSyncStatus().then(t),()=>{this.syncListeners.delete(t)}}subscribeDataChanges(t){return this.dataChangeListeners.add(t),()=>{this.dataChangeListeners.delete(t)}}async notifySyncListeners(){const t=await this.getSyncStatus();this.syncListeners.forEach((e=>{try{e(t)}catch(s){}}))}async notifyDataChangeListeners(){try{const t={activities:new Map(Object.entries(await this.getData("activities")||{})),users:new Map(Object.entries(await this.getData("users")||{})),comments:new Map(Object.entries(await this.getData("comments")||{})),reviews:new Map(Object.entries(await this.getData("reviews")||{}))};this.dataChangeListeners.forEach((e=>{try{e(t)}catch(s){}}))}catch(t){}}async forceSyncNow(){this.isOnline?(await this.syncData(),r.show({type:"success",title:"同步完成",message:"数据已同步到最新状态",duration:3e3})):r.show({type:"warning",title:"网络未连接",message:"请检查网络连接后重试",duration:3e3})}async clearOfflineData(){if(this.db)try{const t=["activities","users","comments","reviews","syncQueue"];for(const e of t){const t=this.db.transaction(e,"readwrite").objectStore(e);await t.clear()}r.show({type:"success",title:"离线数据已清除",message:"本地缓存已清空",duration:3e3}),this.notifyDataChangeListeners()}catch(t){}}async getStorageInfo(){try{if("storage"in navigator&&"estimate"in navigator.storage){const t=await navigator.storage.estimate(),e=t.usage||0,s=t.quota||0;return{used:e,quota:s,percentage:s>0?e/s*100:0}}}catch(t){}return{used:0,quota:0,percentage:0}}async processSync(){if(this.db)try{const e=await this.db.getAll("syncQueue");for(const s of e)try{await this.syncOperation(s);const t=s.entity+"s",e=await this.db.get(t,s.entityId);e&&"syncStatus"in e&&(e.syncStatus="synced",await this.db.put(t,e)),await this.db.delete("syncQueue",s.id)}catch(t){s.retries++,s.retries>=s.maxRetries&&(s.status="failed"),await this.db.put("syncQueue",s)}}catch(t){}}async clearStore(t){if(this.db)try{const e=this.db.transaction(t,"readwrite").objectStore(t);await e.clear()}catch(e){}}},S=()=>{const[t,s]=e.useState({isOnline:navigator.onLine,lastSyncTime:null,pendingOperations:0,failedOperations:0,syncInProgress:!1}),[i,n]=e.useState({activities:new Map,users:new Map,comments:new Map,reviews:new Map});return e.useEffect((()=>{const t=F.subscribeSyncStatus(s),e=F.subscribeDataChanges(n);return()=>{t(),e()}}),[]),{syncStatus:t,offlineData:i,storeData:F.storeData.bind(F),getData:F.getData.bind(F),queueOperation:F.queueOperation.bind(F),forceSyncNow:F.forceSyncNow.bind(F),clearOfflineData:F.clearOfflineData.bind(F),getStorageInfo:F.getStorageInfo.bind(F)}},I={primary:{50:"#FFE8E5",100:"#FFF0F3",200:"#FFA07A",300:"#FF8E7B",400:"#FF7E5F",500:"#FF6B7F",600:"#FF4572",700:"#E91E63"},secondary:{50:"#E0F2FE",100:"#EFF6FF",200:"#7DD3FC",300:"#93C5FD",400:"#60A5FA",500:"#36D1DC",600:"#5B86E5",700:"#4F46E5"},neutral:{50:"#FEF7F0",100:"#F9FAFB",200:"#F3F4F6",300:"#E5E7EB",400:"#9CA3AF",500:"#6B7280",600:"#4B5563",700:"#374151",800:"#1F2937"},accent:{100:"#EFF6FF",200:"#7DD3FC"},success:{primary:"#10B981",secondary:"#059669",soft:"#A7F3D0",subtle:"#DCFCE7"},warning:{primary:"#F59E0B",secondary:"#D97706",soft:"#FEF3C7",subtle:"#FDE68A",500:"#F59E0B"},error:{primary:"#EF4444",secondary:"#DC2626",soft:"#FECACA",subtle:"#FCA5A5"},info:{primary:"#3B82F6",soft:"#DBEAFE",subtle:"#BFDBFE"}},O={soft:"0 2px 8px rgba(0, 0, 0, 0.08)",medium:"0 4px 16px rgba(0, 0, 0, 0.12)",large:"0 8px 32px rgba(0, 0, 0, 0.16)",card:"0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 25px rgba(0, 0, 0, 0.05)"},C={normal:"250ms",easings:{smooth:"cubic-bezier(0.4, 0, 0.2, 1)"}},A={BOULDERING:{color:"#FF6B35",bgColor:"rgba(255, 107, 53, 0.08)",borderColor:"#FF6B35"},TOP_ROPE_AUTO_BELAY:{color:"#3742FA",bgColor:"rgba(55, 66, 250, 0.08)",borderColor:"#3742FA"},TOP_ROPE_MANUAL_BELAY:{color:"#3742FA",bgColor:"rgba(55, 66, 250, 0.08)",borderColor:"#3742FA"},LEAD_CLIMBING:{color:"#8B4513",bgColor:"rgba(139, 69, 19, 0.08)",borderColor:"#8B4513"},OUTDOOR:{color:"#4FC3F7",bgColor:"rgba(225, 245, 254, 0.8)",borderColor:"#4FC3F7"},TRAINING:{color:"#9C27B0",bgColor:"rgba(156, 39, 176, 0.08)",borderColor:"#9C27B0"}};var E=Object.defineProperty,D=(t,e,s)=>((t,e,s)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);const k=new class{constructor(){D(this,"measurements",new Map),D(this,"isEnabled"),D(this,"budget"),D(this,"vitals",{}),D(this,"observers",new Map),this.isEnabled="true"===localStorage.getItem("enablePerformanceMonitoring"),this.budget={bundleSize:2,loadTime:3e3,fcp:1800,lcp:2500,cls:.1},this.isEnabled&&(this.initializeWebVitalsMonitoring(),this.initializeBundleAnalysis())}initializeWebVitalsMonitoring(){if("undefined"!=typeof window&&"PerformanceObserver"in window)try{this.createObserver("paint",(t=>{const e=t.find((t=>"first-contentful-paint"===t.name));e&&(this.vitals.FCP=e.startTime,this.checkBudget("FCP",e.startTime,this.budget.fcp))})),this.createObserver("largest-contentful-paint",(t=>{const e=t[t.length-1];e&&(this.vitals.LCP=e.startTime,this.checkBudget("LCP",e.startTime,this.budget.lcp))})),this.createObserver("first-input",(t=>{const e=t[0];e&&e.processingStart&&(this.vitals.FID=e.processingStart-e.startTime)})),this.createObserver("layout-shift",(t=>{let e=0;for(const s of t)s.hadRecentInput||(e+=s.value);this.vitals.CLS=e,this.checkBudget("CLS",e,this.budget.cls)}))}catch(t){}}createObserver(t,e){try{const s=new PerformanceObserver((t=>{e(t.getEntries())}));s.observe({entryTypes:[t]}),this.observers.set(t,s)}catch(s){}}checkBudget(t,e,s){e.toFixed(2)}initializeBundleAnalysis(){"undefined"!=typeof window&&window.addEventListener("load",(()=>{const t=performance.getEntriesByType("resource");let e=0,s=0,i=0;t.forEach((t=>{t.transferSize&&(e+=t.transferSize,t.name.includes(".js")?s+=t.transferSize:t.name.includes(".css")&&(i+=t.transferSize))})),this.budget.bundleSize}))}start(t){this.isEnabled&&this.measurements.set(t,performance.now())}end(t){if(!this.isEnabled)return null;const e=this.measurements.get(t);if(!e)return null;const s=performance.now(),i={name:t,duration:s-e,startTime:e,endTime:s};return this.measurements.delete(t),i}async measure(t,e){this.start(t);try{return await e()}finally{this.end(t)}}getWebVitals(){return{...this.vitals}}generateReport(){const t=this.getWebVitals();return`\n📊 Performance Report\n===================\nFCP: ${t.FCP?.toFixed(2)||"N/A"}ms\nLCP: ${t.LCP?.toFixed(2)||"N/A"}ms\nFID: ${t.FID?.toFixed(2)||"N/A"}ms\nCLS: ${t.CLS?.toFixed(3)||"N/A"}\n    `.trim()}cleanup(){this.observers.forEach((t=>{t.disconnect()})),this.observers.clear(),this.measurements.clear()}};export{g as a,S as b,I as c,h as d,l as e,C as f,c as g,A as h,d as i,k as j,b as r,O as s,u};
